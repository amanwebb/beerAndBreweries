---
title: "Beer and Breweries"
author: "Tadd Backus & Austin Webb"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(tidyr)
library(tidyverse)
library(caret)
library(class)
library(stringr)
library(e1071)
library(RANN)
library(maps)
library(mapproj)
theme_set(theme_minimal())
```

```{r, echo=FALSE}
beer <- read.csv("/Users/taddbackus/School/summer22/doingDataScience/Unit8/Beers.txt", header=TRUE)
brewery <- read.csv("/Users/taddbackus/School/summer22/doingDataScience/Unit8/Breweries.txt", header=TRUE)
```


# Question 1
## Number of Breweries in each state
```{r, echo=FALSE}
brewery$State = factor(brewery$State)
summary(brewery$State)
brewMap = brewery
lookup = data.frame(abb=state.abb, State=state.name)
brewMap <- rename(brewMap, abb=State)
brewMap$abb = trimws(brewMap$abb)
brewStateMap = merge(brewMap, lookup, by='abb',all=TRUE)
brewMapData = count(brewStateMap,State)
colnames(brewMapData)[2] = 'Breweries'

brewMapData$region <- tolower(brewMapData$State)
brewMapData2 = brewMapData[-1]

states <- map_data('state')
map.df <- merge(states, brewMapData2, by='region', all.x=T)
map.df <- map.df[order(map.df$order),]
```
```{r, echo=FALSE}
ggplot(map.df, aes(x=long,y=lat,group=group))+
  geom_polygon(aes(fill=Breweries))+
  geom_path()+
  scale_fill_gradient2(low='red',mid='green',high='blue',midpoint=24,na.value='grey90')+
  ggtitle('Breweries in each state')+
  theme_void()
```

# Question 2
## Combining the beer and brewery data
```{r, echo=FALSE}
beer_brewery_merged <- merge(beer, brewery, by.x='Brewery_id',by.y='Brew_ID')
head(beer_brewery_merged,6)
```

# Question 3
## Missing values
```{r, echo=FALSE}
sapply(beer_brewery_merged, function(x) sum(is.na(x)))
```
## Categorizing beer type
```{r, echo=FALSE}
beerTypes = c('Ale',
              'Lager',
              'Stout',
              'Porter',
              'Pilsner',
              'Pilsener',
              'IPA',
              'Cider',
              'Oktoberfest',
              'Witbier',
              'KÃ¶lsch',
              'Fruit',
              'Hefeweizen',
              'Other')
beer_brewery_merged$beerCat <- ifelse(grepl(beerTypes[1], beer_brewery_merged$Style), beerTypes[1],
                       ifelse(grepl(beerTypes[2], beer_brewery_merged$Style), beerTypes[2],
                              ifelse(grepl(beerTypes[3], beer_brewery_merged$Style), beerTypes[3],
                                     ifelse(grepl(beerTypes[4], beer_brewery_merged$Style), beerTypes[4],
                                            ifelse(grepl(beerTypes[5], beer_brewery_merged$Style), beerTypes[5],
                                                   ifelse(grepl(beerTypes[6], beer_brewery_merged$Style), beerTypes[5],
                                                          ifelse(grepl(beerTypes[7], beer_brewery_merged$Style), beerTypes[7],
                                                                 ifelse(grepl(beerTypes[8], beer_brewery_merged$Style), beerTypes[8],
                                                                        ifelse(grepl(beerTypes[9], beer_brewery_merged$Style), beerTypes[9],
                                                                        ifelse(grepl(beerTypes[10], beer_brewery_merged$Style), beerTypes[10],
                                                                               ifelse(grepl(beerTypes[11], beer_brewery_merged$Style), beerTypes[11],
                                                                                      ifelse(grepl(beerTypes[12], beer_brewery_merged$Style), beerTypes[12],
                                                                                             ifelse(grepl(beerTypes[13], beer_brewery_merged$Style), beerTypes[13],
                                                                                                    beerTypes[14])))))))))))))

beer_brewery_merged$beerCat = factor(beer_brewery_merged$beerCat)
summary(beer_brewery_merged$beerCat)
```
## Plotting missing values
```{r, echo=FALSE}
ggplot(beer_brewery_merged, aes(x=ABV, y=Brewery_id, color=IBU))+
  geom_point(position='jitter') +
  facet_wrap(~beerCat) +
  scale_color_gradient(low='green', high='red',
                       na.value='blue')
```
## Removing Cider and verifying
```{r, echo=FALSE}
beer_brewery_noCider <- filter(beer_brewery_merged, !beerCat=='Cider')
beer_brewery_noCider$beerCat = factor(beer_brewery_noCider$beerCat)
summary(beer_brewery_noCider$beerCat)
ggplot(beer_brewery_noCider, aes(x=ABV, y=Brewery_id, color=IBU))+
  geom_point(position='jitter')+
  facet_wrap(~beerCat)+
  scale_color_gradient(low='green', high='red',
                       na.value='blue')
```
## Dropping ABV NAs--rework
```{r, echo=FALSE}
beer_brewery_noCider <- filter(beer_brewery_noCider, !is.na(ABV))
```
## kNN Imputation
```{r, echo=FALSE}
preProcValues <- preProcess(beer_brewery_noCider %>%
                              dplyr::select(ABV, IBU, beerCat),
                            method=c('knnImpute'),
                            k=5,
                            knnSummary=mean)
impute_IBU_info <- predict(preProcValues, beer_brewery_noCider, na.action=na.pass)

procNames <- data.frame(col = names(preProcValues$mean), mean=preProcValues$mean, sd=preProcValues$std)
for(i in procNames$col){
  impute_IBU_info[i] <- impute_IBU_info[i]*preProcValues$std[i]+preProcValues$mean[i]
}
ggplot(impute_IBU_info, aes(x=ABV, y=Brewery_id, color=IBU))+
  geom_point(position='jitter')+
  facet_wrap(~beerCat)+
  scale_color_gradient(low='green', high='red',
                       na.value='blue')
```

# Question 4
## Finding median ABV and IBU per State
```{r, echo=FALSE}
ABV_Medians_mean <- impute_IBU_info %>%
  group_by(State) %>%
  summarise(Median=median(ABV))
IBU_Medians_mean <- impute_IBU_info %>%
  group_by(State) %>%
  summarise(Median=median(IBU))

ABV_IBU_merged <- merge(ABV_Medians_mean,
                        IBU_Medians_mean,
                        by='State')
ABV_IBU_merged <- rename(ABV_IBU_merged,
                         'ABV_Median' = 'Median.x')
ABV_IBU_merged <- rename(ABV_IBU_merged,
                         'IBU_Median' = 'Median.y')

ABV_IBU_map = ABV_IBU_merged
ABV_IBU_map <- rename(ABV_IBU_map, abb=State)
ABV_IBU_map$abb = trimws(ABV_IBU_map$abb)
ABV_IBU_stateMap = merge(ABV_IBU_map, lookup, by='abb', all=TRUE)
ABV_IBU_stateMap$region <-tolower(ABV_IBU_stateMap$State)
ABV_IBU_stateMap2 = ABV_IBU_stateMap[-1]
states <- map_data('state')
map2.df <- merge(states, ABV_IBU_stateMap2, by='region', all.x=T)
map2.df <- map2.df[order(map2.df$order),]


ggplot(ABV_Medians_mean, aes(x=State, y=Median, fill=State))+
  geom_bar(width=0.4, position=position_dodge(width=0.05), stat='identity', show.legend=FALSE)+
  ggtitle('Median ABV by State')+
  geom_hline(yintercept=mean(ABV_Medians_mean$Median))+
  xlab('State')+
  ylab('Median')+
  scale_x_discrete(guide=guide_axis(angle=90))
ggplot(map2.df, aes(x=long,y=lat,group=group))+
  geom_polygon(aes(fill=ABV_Median))+
  geom_path()+
  scale_fill_gradient2(low='red',mid='green',high='blue',midpoint=.05)+
  theme_void()+
  ggtitle('Median ABV by State')


ggplot(IBU_Medians_mean, aes(x=State,y=Median,fill=State))+
  geom_bar(width=0.4, position=position_dodge(width=0.05), stat='identity', show.legend=FALSE)+
  ggtitle('Median IBU by State')+
  geom_hline(yintercept=mean(IBU_Medians_mean$Median))+
  xlab('State')+
  ylab('Median')+
  scale_x_discrete(guide=guide_axis(angle=90))
ggplot(map2.df, aes(x=long,y=lat,group=group))+
  geom_polygon(aes(fill=IBU_Median))+
  geom_path()+
  scale_fill_gradient2(low='red',mid='green',high='blue',midpoint=40)+
  theme_void()+
  ggtitle('Median IBU by State')
```

# Question 5
## Max ABV
```{r, echo=FALSE}
impute_IBU_info %>% slice(which.max(impute_IBU_info$ABV))
```
## Max IBU
```{r, echo=FALSE}
impute_IBU_info %>% slice(which.max(impute_IBU_info$IBU))
```
# Question 6
## Stats of ABV
```{r, echo=FALSE}
summary(impute_IBU_info$ABV)

ggplot(impute_IBU_info, aes(x=ABV))+
  geom_histogram(fill='red',color='blue')

ggplot(impute_IBU_info, aes(x=ABV))+
  geom_boxplot(fill='red',color='blue')
```

# Question 7
## ABV vs IBU scatter
```{r, echo=FALSE}
ggplot(impute_IBU_info, aes(x=ABV, y=IBU))+
  geom_point(shape=18, color='red')+
  geom_smooth(method=lm, color='blue', fill='blue')
cor(impute_IBU_info$ABV, impute_IBU_info$IBU)
```

# Question 8
## IPA vs other Ales
aleIPAdf <- filter(impute_IBU_info, beerCat=='IPA' | beerCat=='Ale')
summary(aleIPAdf)
ggplot(aleIPAdf, aes(x=ABV,y=IBU,color=beerCat))+
  geom_point()

# Question 9


